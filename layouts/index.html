{{- define "main" }}

<div class="home-container">
  <!-- Compact calendar -->
  <div class="top-calendar">
    <div class="mini-calendar-widget">
      <div class="mini-cal-nav">
        <button id="mini-prev">â€¹</button>
        <span id="mini-month"></span>
        <button id="mini-next">â€º</button>
      </div>
      <div id="mini-calendar"></div>
      <div id="mini-posts"></div>
    </div>
  </div>

  <!-- Posts list -->
  <div class="posts-list">
    {{- $pages := where site.RegularPages "Type" "in" site.Params.mainSections }}
    {{- $pages = where $pages "Draft" false }}
    {{- range $pages }}
    <article class="post-entry">
      <a href="{{ .Permalink }}" class="entry-link">
        <h2 class="entry-title">{{ .Title }}</h2>
      </a>
      <div class="entry-meta">
        <span class="entry-date">{{ .Date.Format "Jan 2, 2006" }}</span>
        {{- if .Params.tags }}
        {{- range first 3 .Params.tags }}
        <span class="entry-tag">#{{ . }}</span>
        {{- end }}
        {{- end }}
      </div>
      <p class="entry-summary">{{ .Summary | plainify | truncate 150 }}</p>
    </article>
    {{- end }}
  </div>
</div>

<style>
.home-container {
  max-width: 800px;
  margin: 0 auto;
  padding: 0 20px;
}

/* Compact calendar */
.top-calendar {
  display: flex;
  justify-content: center;
  margin-bottom: 40px;
}

.mini-calendar-widget {
  background: var(--code-bg);
  border-radius: 8px;
  padding: 15px;
  width: 280px;
}

.mini-cal-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.mini-cal-nav button {
  background: var(--tertiary);
  border: none;
  width: 28px;
  height: 28px;
  cursor: pointer;
  border-radius: 4px;
  font-size: 16px;
  line-height: 1;
}

.mini-cal-nav button:hover {
  background: var(--secondary);
}

#mini-month {
  font-weight: 600;
  font-size: 14px;
}

#mini-calendar {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
}

.mini-header {
  text-align: center;
  padding: 4px;
  color: var(--secondary);
  font-weight: 600;
  font-size: 10px;
}

.mini-day {
  text-align: center;
  padding: 6px 2px;
  border-radius: 4px;
  cursor: default;
  font-size: 11px;
}

.mini-day.empty {
  background: transparent;
}

.mini-day.has-post {
  background: #ff5a36;
  color: white;
  cursor: pointer;
  font-weight: 600;
}

.mini-day.has-post:hover {
  background: #e04a2a;
}

.mini-day.today {
  border: 2px solid var(--primary);
}

#mini-posts {
  margin-top: 10px;
}

#mini-posts .mini-post-date {
  font-weight: 600;
  margin-bottom: 6px;
  font-size: 11px;
  color: var(--secondary);
}

#mini-posts ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

#mini-posts li {
  padding: 6px 8px;
  margin-bottom: 4px;
  background: var(--tertiary);
  border-radius: 4px;
}

#mini-posts li a {
  text-decoration: none;
  font-size: 11px;
  line-height: 1.3;
}

#mini-posts li a:hover {
  text-decoration: underline;
}

/* Posts list */
.posts-list {
  display: flex;
  flex-direction: column;
  gap: 25px;
}

.post-entry {
  background: var(--code-bg);
  border-radius: 8px;
  padding: 20px 25px;
}

.entry-link {
  text-decoration: none;
  display: block;
}

.entry-title {
  margin: 0 0 12px 0;
  font-size: 1.25rem;
  font-weight: 600;
  line-height: 1.4;
  color: var(--primary);
}

.entry-link:hover .entry-title {
  text-decoration: underline;
}

.entry-meta {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
  font-size: 0.8rem;
}

.entry-date {
  color: var(--secondary);
  font-weight: 500;
}

.entry-tag {
  color: var(--secondary);
  background: var(--tertiary);
  padding: 2px 8px;
  border-radius: 3px;
  font-size: 0.75rem;
}

.entry-summary {
  margin: 0;
  color: var(--secondary);
  font-size: 0.9rem;
  line-height: 1.6;
}
</style>

<script>
const posts = [
  {{- range $index, $page := where .Site.RegularPages "Type" "posts" }}
  {{- if $index }},{{ end }}
  {
    "title": {{ .Title | jsonify }},
    "url": "{{ .Permalink }}",
    "date": "{{ .Date.Format "2006-01-02" }}"
  }
  {{- end }}
];

let currentDate = new Date();
const today = new Date();

function renderMiniCalendar() {
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  
  document.getElementById('mini-month').textContent = 
    currentDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
  
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const startDay = firstDay.getDay();
  const totalDays = lastDay.getDate();
  
  const calendar = document.getElementById('mini-calendar');
  calendar.innerHTML = '';
  
  const days = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
  days.forEach(day => {
    const header = document.createElement('div');
    header.className = 'mini-header';
    header.textContent = day;
    calendar.appendChild(header);
  });
  
  for (let i = 0; i < startDay; i++) {
    const empty = document.createElement('div');
    empty.className = 'mini-day empty';
    calendar.appendChild(empty);
  }
  
  for (let day = 1; day <= totalDays; day++) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const dayPosts = posts.filter(p => p.date === dateStr);
    
    const dayEl = document.createElement('div');
    dayEl.className = 'mini-day';
    dayEl.textContent = day;
    
    if (dayPosts.length > 0) {
      dayEl.classList.add('has-post');
      dayEl.onclick = () => showMiniPosts(dateStr, dayPosts);
    }
    
    if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
      dayEl.classList.add('today');
    }
    
    calendar.appendChild(dayEl);
  }
}

function showMiniPosts(date, dayPosts) {
  const container = document.getElementById('mini-posts');
  const dateObj = new Date(date + 'T00:00:00');
  const formatted = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  
  container.innerHTML = `<div class="mini-post-date">ðŸ“… ${formatted}</div><ul>` + 
    dayPosts.map(p => `<li><a href="${p.url}">${p.title}</a></li>`).join('') +
    '</ul>';
}

document.getElementById('mini-prev').onclick = () => {
  currentDate.setMonth(currentDate.getMonth() - 1);
  renderMiniCalendar();
};

document.getElementById('mini-next').onclick = () => {
  currentDate.setMonth(currentDate.getMonth() + 1);
  renderMiniCalendar();
};

renderMiniCalendar();
</script>

{{- end }}
